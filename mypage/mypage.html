<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Page</title>
    <link rel="stylesheet" href="../mypage/mypage.css" />

    <style>
      .main-container {
        display: none;
      }
    </style>
    <script>
      const isLoggedIn = localStorage.getItem("isLoggedIn");
      if (isLoggedIn !== "true") {
        // ë¡œê·¸ì¸ ì•ˆëœ ê²½ìš° ë°”ë¡œ ë¦¬ë””ë ‰ì…˜ (ë Œë”ë§ ì´ì „)
        window.location.replace("../login/login.html");
      } else {
        // ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ body ë³´ì—¬ì£¼ê¸°
        window.addEventListener("DOMContentLoaded", function () {
          document.body.style.display = "block";
        });
      }
    </script>
  </head>

  <body>
    <div class="main-container">
      <div id="sidebar-container"></div>

      <div class="inner">
        <h2 class="whose-profile">ê¹€ê¸°í˜„ ë‹˜ì˜ íˆ¬ì–´ìŠ¤</h2>
        <div class="profile-section">
          <img
            class="profile-image"
            src="../mypage/mypage_img/ê¹€ê¸°í˜„_ì¦ëª…ì‚¬ì§„1.jpg"
            alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
          />
          <div class="profile-info">
            <p class="username">
              ê¹€ê¸°í˜„ <span class="userid">@watergon1126</span>
            </p>
            <div class="stats">
              <div>
                <strong>3<br />íˆ¬ì–´ìŠ¤</strong>
              </div>
              <div>
                <strong>151<br />ë¦¬ë·° ì‘ì„±</strong>
              </div>
              <div>
                <strong>156<br />ì¢‹ì•„ìš”</strong>
              </div>
            </div>
          </div>
          <button
            class="edit-profile"
            onclick="window.location.href='../edit/edit.html';"
          >
            í”„ë¡œí•„ í¸ì§‘
          </button>
          <button class="delete-account">íšŒì›íƒˆí‡´</button>
        </div>

        <p class="profile-message">ì œì£¼ë„ ì—¬í–‰ê°€ë ¤ê³  ëˆ ëª¨ìœ¼ëŠ” ì¤‘...</p>
        <hr />

        <div class="tour-section">
          <h3>ë‹¤ë…€ì˜¬ íˆ¬ì–´ìŠ¤ ğŸ§³</h3>
          <div class="tour-list upcoming"></div>
          <!-- ë‹¤ë…€ì˜¬ íˆ¬ì–´ìŠ¤ -->
        </div>

        <div class="tour-section">
          <h3>ë‹¤ë…€ì˜¨ íˆ¬ì–´ìŠ¤ ğŸ“·</h3>
          <div class="tour-list completed"></div>
          <!-- ë‹¤ë…€ì˜¨ íˆ¬ì–´ìŠ¤ -->
        </div>
      </div>
    </div>

    <script>
      // fetchë¡œ ì‚¬ì´ë“œë°” HTMLì„ ë¶ˆëŸ¬ì˜¤ê³  ë‚˜ì„œ ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬
      fetch("../sidebar/sidebar.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("sidebar-container").innerHTML = data; // ì‚¬ì´ë“œë°” ì‚½ì…

          // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ì²˜ë¦¬
          const isLoggedIn = localStorage.getItem("isLoggedIn"); // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
          const logOutButton = document.querySelector(".sidebar-logOut"); // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼

          if (logOutButton) {
            if (isLoggedIn === "true") {
              logOutButton.style.display = "block"; // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë²„íŠ¼ ë³´ì´ê¸°
            } else {
              logOutButton.style.display = "none"; // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            }
          }
        });
    </script>

    <script src="../sidebar/sidebar.js"></script>
    <script src="../mypage/mypage.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const currentDate = new Date();
        const savedSchedules = JSON.parse(
          localStorage.getItem("savedSchedule")
        );

        if (!savedSchedules || !Array.isArray(savedSchedules)) {
          console.log("ì—¬í–‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ì¥ì†Œ ë°ì´í„° ë¡œë“œ
        let placeDataItems = [];
        try {
          const response = await fetch("../listEx.json");
          if (!response.ok)
            throw new Error("ì¥ì†Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          const placeData = await response.json();
          placeDataItems = Array.isArray(placeData)
            ? placeData
            : placeData.items;
        } catch (error) {
          console.error("ì¥ì†Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }

        const upcomingTourSection = document.querySelector(
          ".tour-section .tour-list.upcoming"
        );
        const completedTourSection = document.querySelector(
          ".tour-section .tour-list.completed"
        );

        const upcomingTours = savedSchedules.filter(
          (tour) => new Date(tour.startDate) >= currentDate
        );
        const completedTours = savedSchedules.filter(
          (tour) => new Date(tour.endDate) < currentDate
        );

        upcomingTours.sort(
          (a, b) => new Date(a.startDate) - new Date(b.startDate)
        );
        completedTours.sort((a, b) => b.index - a.index);

        function getImageForPlace(placeName) {
          const matched = placeDataItems.find(
            (place) => place.placeName === placeName
          );
          return (
            matched?.images?.[0] ||
            "https://api.cdn.visitjeju.net/photomng/imgpath/202409/20/b2087c57-7cb6-420d-a840-c6e7e581072e.png"
          );
        }

        function createTourCard(tour) {
          const { startDate, endDate, schedule, index } = tour;
          const firstPlace = schedule[0]?.places?.[0] || "ì—¬í–‰ì§€ ë¯¸ì •";
          const displayTitle = tour.title?.trim() || firstPlace;

          const tourCard = document.createElement("div");
          tourCard.classList.add("tour-card");

          const tourImage = document.createElement("img");
          tourImage.classList.add("tour-image");
          tourImage.src = getImageForPlace(firstPlace);
          tourImage.alt = `${firstPlace} ì—¬í–‰`;

          const tourInfo = document.createElement("div");
          tourInfo.classList.add("tour-info");

          const tourTitleContainer = document.createElement("div");
          tourTitleContainer.style.display = "flex";
          tourTitleContainer.style.alignItems = "center";
          tourTitleContainer.style.gap = "8px";

          const tourTitle = document.createElement("h4");
          tourTitle.textContent = displayTitle;

          const editButton = document.createElement("button");
          editButton.textContent = "âœï¸";
          editButton.style.fontSize = "14px";
          editButton.style.cursor = "pointer";
          editButton.style.padding = "2px 6px";
          editButton.style.border = "1px solid #ccc";
          editButton.style.borderRadius = "4px";
          editButton.style.backgroundColor = "#f0f0f0";

          editButton.addEventListener("click", () => {
            const newTitle = prompt(
              "ì—¬í–‰ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:",
              tourTitle.textContent
            );
            if (newTitle && newTitle.trim() !== "") {
              tourTitle.textContent = newTitle.trim();

              const allSchedules = JSON.parse(
                localStorage.getItem("savedSchedule")
              );
              const updateIndex = allSchedules.findIndex(
                (item) => item.index === index
              );
              if (updateIndex !== -1) {
                allSchedules[updateIndex].title = newTitle.trim();
                localStorage.setItem(
                  "savedSchedule",
                  JSON.stringify(allSchedules)
                );
              }
            }
          });

          tourTitleContainer.appendChild(tourTitle);
          tourTitleContainer.appendChild(editButton);

          const tourDate = document.createElement("p");
          tourDate.classList.add("tour-date");
          tourDate.textContent = `${startDate} ~ ${endDate}`;

          const tourPlan = document.createElement("p");
          tourPlan.classList.add("tour-plan");
          tourPlan.innerHTML = schedule
            .map((day) => {
              const date = day.date;
              const places = day.places.join(", ");
              return `<strong>${date}</strong>: ${places}`;
            })
            .join("<br />");

          tourInfo.appendChild(tourTitleContainer);
          tourInfo.appendChild(tourDate);
          tourInfo.appendChild(tourPlan);

          tourCard.appendChild(tourImage);
          tourCard.appendChild(tourInfo);

          return tourCard;
        }

        upcomingTours.forEach((tour) => {
          const card = createTourCard(tour);
          upcomingTourSection.appendChild(card);
        });

        completedTours.forEach((tour) => {
          const card = createTourCard(tour);
          completedTourSection.appendChild(card);
        });
      });
    </script>
  </body>
</html>
